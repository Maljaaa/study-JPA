# 영속성 관리
JPA가 제공하는 기능은 **엔티티와 테이블을 매핑하는 설계 부분**과 **매핑한 엔티티를 실제 사용하는 부분**으로 나눌 수 있다.

## 엔티티 매니저 팩토리와 엔티티 매니저

![일반적인 웹 애플리케이션](https://user-images.githubusercontent.com/6037055/43312616-d026e46c-91c8-11e8-91d3-4d547753a096.png)

`엔티티 매니저 팩토리`는 여러 스레드가 동시에 접근해도 안전하므로 서로 다른 스레드 간에 공유해도 된다.  
`엔티티 매니저`는 여러 스레드가 동시에 접근하면 동시성 문제가 발생하므로 스레드 간에 절대 공유하면 안 된다.  

  
## 영속성 컨텍스트란?
🚀 영속성 컨텍스트 : 엔티티를 영구 저장하는 환경, 논리적인 개념이고 엔티티 매니저를 생성할 때 1:1로 만들어진다.  
> 엔티티 매니저를 통해서 영속성 컨텍스트에 접근,관리할 수 있다.
> 여러 엔티티 매니저가 같은 영속성 컨텍스트에 접근할 수도 있다.
  
## 엔티티의 생명주기

![생명주기](https://ultrakain.gitbooks.io/jpa/content/chapter3/images/JPA_3_2.png)
* 비영속(new/transient) : 영속성 컨텍스트와 관계 없음
![비영속 상태](https://user-images.githubusercontent.com/45676906/130695446-64aeef1b-b4b4-4446-9aaa-2db7ee114e43.png)
  - 엔티티 객체를 생성  
* 영속(managed) : 영속성 컨텍스트에 저장됨
![영속 상태](https://oopy.lazyrockets.com/api/v2/notion/image?src=https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F1fa744ff-d637-4981-913e-93634db479c4%2F_2020-07-19__6.22.14.png&blockId=93239c6d-8fa1-46ba-9c76-c9c0de083d29)
  - 엔티티를 영속성 컨텍스트에 저장
  - 영속성 컨텍스트가 관리하는 엔티티를 **영속 상태**
  
* 준영속(detached) : 영속성 컨텍스트에 저정되었다가 분리됨
  - detach(), close(), clear()를 호출하면 준영속 상태가 됨
    
* 삭제(removed) : 삭제됨
  - 엔티티를 영속성 컨텍스트와 DB에서 삭제
  
## 영속성 컨텍스트의 특징
* 영속성 컨텍스트와 식별자 값 : 영속성 컨텍스트는 엔티티를 식별자 값으로 구분하기 때문에 식별자 값이 무조건 있어야 한다.
* 영속성 컨텍스트와 DB 저장 : **트랜잭션을 커밋하는 순간** 영속성 컨텍스트에 새로 저장된 엔티티를 DB에 반영한다. 이걸 `플러시(flush)`라고 한다.
* 장점 5가지
  - 1차 캐시 : 영속성 컨텍스트 내부에 가지고 있는 캐시, 쉽게 말해 Map이 있고 Key는 @Id로 매핑한 식별자, Value는 엔티티 인스턴스다.
    
  ```
  // EntityManager.find()의 정의
  public <T> T find(Class<T> entityClass, Object primaryKey);
  ```
  find()메소드의 첫 번째 파라미터는 엔티티 클래스 타입이고, 두 번째 파라미터는 엔티티의 식별자 값이다.  
    
  find() 호출 -> 1차 캐시에서 엔티티 찾음 -> 없으면 DB에서 조회 순서로 진행된다.  
  

## 플러시

## 준영속

## 정리
